<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Waggle Architecture</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            margin: 0;
            padding: 20px;
            background: #0d1117;
            color: #c9d1d9;
        }
        h1 { color: #58a6ff; text-align: center; margin-bottom: 10px; }
        h2 { color: #f0883e; margin-top: 40px; border-bottom: 1px solid #30363d; padding-bottom: 10px; }
        h3 { color: #7ee787; }
        .subtitle { text-align: center; color: #8b949e; margin-bottom: 30px; }
        .container { max-width: 1400px; margin: 0 auto; }
        .diagram-container {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            overflow-x: auto;
        }
        .mermaid { text-align: center; }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border: 1px solid #30363d;
        }
        th { background: #21262d; color: #58a6ff; }
        tr:hover { background: #161b22; }
        code {
            background: #21262d;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'SF Mono', Consolas, monospace;
            color: #f0883e;
        }
        .module-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .module-card {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 20px;
        }
        .module-card h3 {
            margin-top: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .module-card p { color: #8b949e; margin: 10px 0; }
        .module-card ul { margin: 0; padding-left: 20px; }
        .module-card li { margin: 5px 0; }
        .emoji { font-size: 1.5em; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üêù Waggle Architecture</h1>
        <p class="subtitle">Multi-agent orchestration through the waggle dance</p>

        <h2>System Overview</h2>
        <div class="diagram-container">
            <div class="mermaid">
flowchart TB
    subgraph User["User Interface"]
        CLI["CLI (cmd/waggle)"]
        TUI["TUI Dashboard"]
    end

    subgraph Queen["üëë Queen (Orchestrator)"]
        Agent["agent.go<br/>Autonomous Loop"]
        Tools["tools.go<br/>11 Tool Handlers"]
    end

    subgraph LLM["üß† LLM Layer"]
        LLMClient["llm.Client"]
        Anthropic["Anthropic"]
        OpenAI["OpenAI"]
        Gemini["Gemini"]
    end

    subgraph Workers["üêù Worker Layer"]
        Pool["worker.Pool"]
        Bee1["Worker 1"]
        Bee2["Worker 2"]
        Bee3["Worker N"]
    end

    subgraph Adapters["üîå Adapters"]
        Registry["Registry"]
        Claude["Claude"]
        Kimi["Kimi"]
        Exec["Exec"]
    end

    subgraph Core["Core Services"]
        TaskGraph["task.TaskGraph"]
        Bus["bus.MessageBus"]
        Blackboard["Blackboard"]
        Safety["Safety Guard"]
    end

    subgraph Persistence["üíæ Persistence"]
        DB[("SQLite")]
        Config["Config"]
    end

    CLI --> Agent
    Agent <--> LLMClient
    LLMClient --> Anthropic
    LLMClient --> OpenAI
    LLMClient --> Gemini

    Agent --> Tools
    Tools --> TaskGraph
    Tools --> Pool
    Tools --> Safety

    Pool --> Registry
    Registry --> Claude
    Registry --> Kimi
    Registry --> Exec

    Claude --> Bee1
    Kimi --> Bee2
    Exec --> Bee3

    Bee1 -.-> Bus
    Bee2 -.-> Bus
    Bee3 -.-> Bus

    Bus --> TUI
    Bus --> Blackboard
    Bus --> DB

    TaskGraph <--> DB
    Config --> Agent
            </div>
        </div>

        <h2>Internal Modules</h2>
        <div class="module-grid">
            <div class="module-card">
                <h3><span class="emoji">üëë</span> queen</h3>
                <p>Central orchestrator - autonomous LLM agent loop</p>
                <ul>
                    <li><code>agent.go</code> - Agent mode loop</li>
                    <li><code>tools.go</code> - 11 tool handlers</li>
                    <li><code>queen.go</code> - Legacy orchestration</li>
                    <li><code>prompt.go</code> - System prompt builder</li>
                </ul>
            </div>
            <div class="module-card">
                <h3><span class="emoji">üß†</span> llm</h3>
                <p>Provider-agnostic LLM interface</p>
                <ul>
                    <li><code>Client</code> - Basic chat interface</li>
                    <li><code>ToolClient</code> - Tool-use support</li>
                    <li>Anthropic, OpenAI, Gemini, CLI</li>
                </ul>
            </div>
            <div class="module-card">
                <h3><span class="emoji">üìã</span> task</h3>
                <p>Task graph with dependency tracking</p>
                <ul>
                    <li><code>Task</code> - Work unit with metadata</li>
                    <li><code>TaskGraph</code> - Thread-safe DAG</li>
                    <li>Status: pending ‚Üí running ‚Üí complete</li>
                </ul>
            </div>
            <div class="module-card">
                <h3><span class="emoji">üêù</span> worker</h3>
                <p>Worker pool management</p>
                <ul>
                    <li><code>Pool</code> - Concurrency control</li>
                    <li><code>Bee</code> - Worker interface</li>
                    <li>Timeout handling, graceful shutdown</li>
                </ul>
            </div>
            <div class="module-card">
                <h3><span class="emoji">üîå</span> adapter</h3>
                <p>CLI wrapper adapters</p>
                <ul>
                    <li><code>Registry</code> - Adapter storage</li>
                    <li><code>TaskRouter</code> - Type ‚Üí adapter mapping</li>
                    <li>Claude, Kimi, Codex, Gemini, Exec</li>
                </ul>
            </div>
            <div class="module-card">
                <h3><span class="emoji">üì®</span> bus</h3>
                <p>In-process pub/sub event system</p>
                <ul>
                    <li><code>MessageBus</code> - Event dispatcher</li>
                    <li>Task, Worker, Queen, System events</li>
                    <li>Subscribe/Unsubscribe pattern</li>
                </ul>
            </div>
            <div class="module-card">
                <h3><span class="emoji">üìù</span> blackboard</h3>
                <p>Shared memory for inter-agent comms</p>
                <ul>
                    <li>Key-value store with history</li>
                    <li>Query by tag or worker</li>
                    <li>Coordination data</li>
                </ul>
            </div>
            <div class="module-card">
                <h3><span class="emoji">üíæ</span> state</h3>
                <p>SQLite persistence (WAL mode)</p>
                <ul>
                    <li>Sessions, Tasks, Events tables</li>
                    <li>Blackboard, KV, Messages</li>
                    <li>Session resume support</li>
                </ul>
            </div>
            <div class="module-card">
                <h3><span class="emoji">üõ°Ô∏è</span> safety</h3>
                <p>Security guard</p>
                <ul>
                    <li>Path allowlist validation</li>
                    <li>Command blocklist filtering</li>
                    <li>File size limits, read-only mode</li>
                </ul>
            </div>
            <div class="module-card">
                <h3><span class="emoji">‚öôÔ∏è</span> config</h3>
                <p>Configuration management</p>
                <ul>
                    <li><code>waggle.json</code> loader</li>
                    <li>Queen, Worker, Adapter configs</li>
                    <li>Safety settings</li>
                </ul>
            </div>
            <div class="module-card">
                <h3><span class="emoji">üì¶</span> compact</h3>
                <p>Context window compaction</p>
                <ul>
                    <li>Token estimation</li>
                    <li>Message summarization</li>
                    <li>History compression</li>
                </ul>
            </div>
            <div class="module-card">
                <h3><span class="emoji">üö®</span> errors</h3>
                <p>Error classification & retry</p>
                <ul>
                    <li>Retryable vs Permanent</li>
                    <li>Pattern-based classification</li>
                    <li>Exponential backoff</li>
                </ul>
            </div>
        </div>

        <h2>Execution Flow</h2>
        <div class="diagram-container">
            <div class="mermaid">
sequenceDiagram
    participant User
    participant Queen
    participant LLM
    participant TaskGraph
    participant Pool
    participant Worker
    participant DB

    User->>Queen: Run(objective)
    Queen->>DB: CreateSession()
    Queen->>LLM: ChatWithTools()
    
    loop Agent Loop
        LLM-->>Queen: tool_calls
        
        alt create_tasks
            Queen->>TaskGraph: Add(tasks)
        else assign_task
            Queen->>Pool: Spawn(task)
            Pool->>Worker: Start
        else wait_for_workers
            Worker-->>Queen: Result
        else approve/reject
            Queen->>TaskGraph: SetStatus()
        else complete/fail
            Queen->>DB: UpdateSession()
            Queen-->>User: Report
        end
        
        Queen->>LLM: ChatWithTools(results)
    end
            </div>
        </div>

        <h2>Task State Machine</h2>
        <div class="diagram-container">
            <div class="mermaid">
stateDiagram-v2
    [*] --> pending: create_tasks
    
    pending --> assigned: assign_task
    assigned --> running: Worker starts
    
    running --> complete: Success
    running --> failed: Error
    
    complete --> pending: reject_task
    
    failed --> retrying: Can retry
    retrying --> pending: Backoff done
            </div>
        </div>

        <h2>Queen's Tools</h2>
        <table>
            <tr><th>Tool</th><th>Purpose</th></tr>
            <tr><td><code>create_tasks</code></td><td>Create tasks in the graph with types, priorities, dependencies</td></tr>
            <tr><td><code>assign_task</code></td><td>Assign a pending task to a worker</td></tr>
            <tr><td><code>wait_for_workers</code></td><td>Block until workers complete</td></tr>
            <tr><td><code>get_status</code></td><td>Get current status of all tasks</td></tr>
            <tr><td><code>get_task_output</code></td><td>Read completed/failed task output</td></tr>
            <tr><td><code>approve_task</code></td><td>Mark task as approved</td></tr>
            <tr><td><code>reject_task</code></td><td>Reject task with feedback, re-queue</td></tr>
            <tr><td><code>read_file</code></td><td>Read a project file (safety-checked)</td></tr>
            <tr><td><code>list_files</code></td><td>List directory contents</td></tr>
            <tr><td><code>complete</code></td><td>Declare objective complete</td></tr>
            <tr><td><code>fail</code></td><td>Declare objective failed</td></tr>
        </table>

        <h2>Worker Adapters</h2>
        <table>
            <tr><th>Adapter</th><th>CLI</th><th>Command</th></tr>
            <tr><td><code>claude-code</code></td><td>Claude Code</td><td><code>claude -p "&lt;prompt&gt;"</code></td></tr>
            <tr><td><code>kimi</code></td><td>Kimi Code</td><td><code>kimi --print --final-message-only -p "&lt;prompt&gt;"</code></td></tr>
            <tr><td><code>gemini</code></td><td>Gemini CLI</td><td><code>echo "&lt;prompt&gt;" | gemini</code></td></tr>
            <tr><td><code>codex</code></td><td>Codex</td><td><code>codex exec "&lt;prompt&gt;"</code></td></tr>
            <tr><td><code>opencode</code></td><td>OpenCode</td><td><code>opencode run "&lt;prompt&gt;"</code></td></tr>
            <tr><td><code>exec</code></td><td>Shell</td><td><code>bash -c "&lt;description&gt;"</code></td></tr>
        </table>
    </div>

    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'dark',
            themeVariables: {
                primaryColor: '#238636',
                primaryTextColor: '#c9d1d9',
                primaryBorderColor: '#30363d',
                lineColor: '#8b949e',
                secondaryColor: '#21262d',
                tertiaryColor: '#161b22'
            }
        });
    </script>
</body>
</html>
